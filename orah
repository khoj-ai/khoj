#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/orah.yml"
OVERRIDE_FILE="$SCRIPT_DIR/docker-compose.override.yml"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_error() {
    echo -e "${RED}Error: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

# Check if orah.yml exists
check_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        print_error "Config file not found: $CONFIG_FILE"
        echo "Create one from the example:"
        echo "  cp orah.yml.example orah.yml"
        echo "  # Edit orah.yml with your folder paths"
        exit 1
    fi
}

# Parse orah.yml and generate docker-compose.override.yml
generate_override() {
    check_config

    echo "Reading config from $CONFIG_FILE..."

    # Use Python to parse YAML and expand paths
    local volumes
    volumes=$(python3 << 'PYTHON_SCRIPT'
import yaml
import os
import sys

config_path = os.environ.get('CONFIG_FILE', 'orah.yml')

try:
    with open(config_path) as f:
        config = yaml.safe_load(f)
except Exception as e:
    print(f"Error reading config: {e}", file=sys.stderr)
    sys.exit(1)

folders = config.get('sync', {}).get('folders', [])

if not folders:
    print("No folders configured in orah.yml", file=sys.stderr)
    sys.exit(1)

volume_mounts = []
used_names = set()  # Track used names to avoid duplicates

for folder in folders:
    # Support both simple string format and object format with path/name
    if isinstance(folder, str):
        folder_path = folder
        custom_name = None
    elif isinstance(folder, dict):
        folder_path = folder.get('path')
        custom_name = folder.get('name')
        if not folder_path:
            print(f"Warning: Folder entry missing 'path': {folder}", file=sys.stderr)
            continue
    else:
        print(f"Warning: Invalid folder entry: {folder}", file=sys.stderr)
        continue
    
    # Expand ~ to home directory
    expanded = os.path.expanduser(folder_path)
    
    # Get absolute path
    abs_path = os.path.abspath(expanded)
    
    # Validate path exists
    if not os.path.exists(abs_path):
        print(f"Warning: Path does not exist: {abs_path}", file=sys.stderr)
        continue
    
    if not os.path.isdir(abs_path):
        print(f"Warning: Path is not a directory: {abs_path}", file=sys.stderr)
        continue
    
    # Determine mount name: use custom name if provided, otherwise use folder basename
    if custom_name:
        mount_name = custom_name
    else:
        mount_name = os.path.basename(abs_path.rstrip('/'))
    
    # Validate name is unique
    if mount_name in used_names:
        print(f"Error: Duplicate folder name '{mount_name}'. Use 'name:' to specify unique names.", file=sys.stderr)
        sys.exit(1)
    used_names.add(mount_name)
    
    container_path = f"/data/sync/{mount_name}"
    
    volume_mounts.append(f"      - {abs_path}:{container_path}")

if not volume_mounts:
    print("No valid folders found", file=sys.stderr)
    sys.exit(1)

print('\n'.join(volume_mounts))
PYTHON_SCRIPT
    )

    if [[ -z "$volumes" ]]; then
        print_error "No valid folders to mount"
        exit 1
    fi

    # Generate docker-compose.override.yml
    cat > "$OVERRIDE_FILE" << EOF
# Auto-generated by orah CLI - do not edit manually
# Regenerate with: ./orah up

services:
  server:
    volumes:
$volumes
EOF

    print_success "Generated $OVERRIDE_FILE"
}

# Commands
cmd_up() {
    generate_override
    echo "Starting containers..."
    docker-compose -f "$SCRIPT_DIR/docker-compose.yml" -f "$OVERRIDE_FILE" up -d "$@"
    print_success "Containers started!"
    echo ""
    echo "Khoj is running at: http://localhost:42110"
    echo "View logs with: ./orah logs"
}

cmd_down() {
    echo "Stopping containers..."
    docker-compose -f "$SCRIPT_DIR/docker-compose.yml" down "$@"
    print_success "Containers stopped"
}

cmd_restart() {
    cmd_down
    cmd_up
}

cmd_logs() {
    docker-compose -f "$SCRIPT_DIR/docker-compose.yml" logs -f server "$@"
}

cmd_status() {
    docker-compose -f "$SCRIPT_DIR/docker-compose.yml" ps
}

cmd_help() {
    echo "orah - CLI for managing Khoj with folder sync"
    echo ""
    echo "Usage: ./orah <command> [options]"
    echo ""
    echo "Commands:"
    echo "  up        Generate config and start containers"
    echo "  down      Stop containers"
    echo "  restart   Restart containers (regenerates config)"
    echo "  logs      Tail container logs"
    echo "  status    Show container status"
    echo "  help      Show this help message"
    echo ""
    echo "Configuration:"
    echo "  Edit orah.yml to configure folders to sync."
    echo "  See orah.yml.example for reference."
}

# Main
case "${1:-}" in
    up)
        shift
        cmd_up "$@"
        ;;
    down)
        shift
        cmd_down "$@"
        ;;
    restart)
        shift
        cmd_restart "$@"
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    status)
        shift
        cmd_status "$@"
        ;;
    help|--help|-h)
        cmd_help
        ;;
    "")
        cmd_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        cmd_help
        exit 1
        ;;
esac
