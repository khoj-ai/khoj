# Progress Log
# Generated by sonata
# Started: 2026-01-24T17:55:01.603Z
# Task file: Spec: First class folder sync support

---

## Iteration 1 - 2026-01-24

### Task Completed
- Added `LocalFolderConfig` and `LocalFolder` models (combined first two spec tasks)

### Key Decisions
- `LocalFolderConfig`: OneToOneField to KhojUser with `enabled` flag (per-user config)
- `LocalFolder`: ForeignKey to LocalFolderConfig with `path` (CharField max 1000) and `last_synced_at` (DateTimeField, nullable)
- Used `unique_together = ["config", "path"]` to prevent duplicate folder paths per user
- Followed existing patterns from GithubConfig/GithubRepoConfig models
- Both models inherit from DbBaseModel (includes created_at, updated_at)

### Files Changed
- src/khoj/database/models/__init__.py (added LocalFolderConfig and LocalFolder models)

### Notes
- Models added at end of file after UserMemory model
- Python syntax verified
- Next steps: Add database adapters for CRUD operations, then create migration

---

## Iteration 2 - 2026-01-24

### Task Completed
- Added database adapters for folder config CRUD operations

### Key Decisions
- Created `LocalFolderConfigAdapters` class following existing adapter patterns
- Provided both sync and async versions of methods (prefixed with `a` for async)
- Used `@require_valid_user` and `@arequire_valid_user` decorators for user validation
- Adapter methods include:
  - `get_or_create_config` / `aget_or_create_config` - Get or create user's config
  - `get_config` / `aget_config` - Get config with prefetched folders
  - `set_enabled` / `aset_enabled` - Enable/disable folder sync
  - `is_enabled` / `ais_enabled` - Check if sync is enabled
  - `get_folders` / `aget_folders` - List all folders for user
  - `add_folder` / `aadd_folder` - Add a folder path (idempotent)
  - `remove_folder` / `aremove_folder` - Remove a folder path
  - `get_folder_by_path` / `aget_folder_by_path` - Get specific folder
  - `update_folder_sync_time` / `aupdate_folder_sync_time` - Update last_synced_at
  - `get_all_enabled_configs` / `aget_all_enabled_configs` - Server-wide query for all enabled configs

### Files Changed
- src/khoj/database/adapters/__init__.py (added LocalFolder and LocalFolderConfig imports, added LocalFolderConfigAdapters class)

### Notes
- Python syntax verified
- Followed existing patterns from GithubConfig adapters and other adapter classes
- Next steps: Create database migration for new models

---

## Iteration 3 - 2026-01-24

### Task Completed
- Created database migration for LocalFolderConfig and LocalFolder models

### Key Decisions
- Migration number: 0100 (following 0099_usermemory.py)
- Depends on: ("database", "0099_usermemory")
- Creates LocalFolderConfig first (parent model), then LocalFolder (child with FK)
- LocalFolderConfig includes: id, created_at, updated_at, enabled, user (OneToOne)
- LocalFolder includes: id, created_at, updated_at, path, last_synced_at, config (FK)
- Followed exact patterns from 0099_usermemory.py migration

### Files Changed
- src/khoj/database/migrations/0100_localfolderconfig_localfolder.py (new file)

### Notes
- Python syntax verified with py_compile
- Migration follows Django conventions for model creation order (parent before child)
- unique_together constraint added for (config, path) pair
- Next steps: Add API endpoints for folder management

---

## Iteration 4 - 2026-01-24

### Task Completed
- Added API endpoints for folder management (list, add, remove, sync)

### Key Decisions
- Added 5 endpoints to api_content.py:
  - `GET /api/content/folders` - List all folders and config status
  - `POST /api/content/folders` - Add a new folder path (validates path exists and is directory)
  - `DELETE /api/content/folders?path=...` - Remove a folder by path
  - `POST /api/content/folders/enabled` - Enable/disable folder syncing
  - `POST /api/content/folders/sync` - Trigger a manual sync (placeholder for folder_watcher integration)
- Created Pydantic models for request/response schemas:
  - `LocalFolderAddRequest` - Request body for adding folders
  - `LocalFolderResponse` - Single folder with path and last_synced_at
  - `LocalFolderConfigResponse` - Full config with enabled flag and folders list
  - `LocalFolderSetEnabledRequest` - Request body for enabling/disabling
- Path validation: Must be absolute path, must exist, must be directory
- All endpoints use async adapters and include telemetry tracking
- Follows existing patterns from GitHub/Notion config endpoints

### Files Changed
- src/khoj/routers/api_content.py (added imports, Pydantic models, and 5 API endpoints)

### Notes
- Python syntax verified with py_compile
- Ruff linting not available in environment but code follows project conventions
- Sync endpoint is a placeholder - actual sync logic will be in folder_watcher module
- Next steps: Implement watchdog-based file watcher service

---

## Iteration 5 - 2026-01-24

### Task Completed
- Implemented `watchdog`-based file watcher service

### Key Decisions
- Created `src/khoj/processor/content/folder_watcher.py` with the following components:
  - `SUPPORTED_EXTENSIONS`: Set of file extensions supported for indexing (.md, .org, .txt, .pdf, .docx, .jpg, .png, .webp)
  - `get_file_type_from_extension()`: Maps file extensions to Khoj file types (markdown, org, plaintext, pdf, docx, image)
  - `is_supported_file()`: Check if a file should be indexed based on extension
  - `FolderEventHandler`: Watchdog event handler that:
    - Handles file create/modify/delete events
    - Filters to only supported file types
    - Debounces events (2 second default) to batch changes
    - Accumulates changes and calls callback with batched changes dict
    - Handles directory creation by scanning for supported files
  - `FolderWatcherService`: Main service class that:
    - Manages multiple folder watches across users
    - Provides start/stop lifecycle management
    - Supports add_folder/remove_folder per user
    - Uses threading.Lock for thread safety
    - Provides get_watched_folders() and is_running() status methods
  - `scan_folder_for_files()`: Utility to scan folder and categorize files by type
  - `collect_files_for_indexing()`: Reads file contents into format expected by configure_content()
  - `get_folder_watcher_service()`: Global singleton accessor
- Added `watchdog >= 4.0.0` to dependencies in pyproject.toml
- Event handling logic prevents duplicate events:
  - Created then modified = still just created
  - Modified then deleted = just deleted
  - Created then deleted = removed from both

### Files Changed
- pyproject.toml (added watchdog dependency)
- src/khoj/processor/content/folder_watcher.py (new file)

### Notes
- Python syntax verified
- pyproject.toml TOML syntax verified
- Service is designed to be started on server startup and stopped on shutdown
- Callback mechanism allows integration with configure_content() pipeline
- Next steps: Integrate file watcher with existing configure_content() pipeline

